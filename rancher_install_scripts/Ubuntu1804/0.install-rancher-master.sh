#################################################################################################
### Rancher 2.3.x on Ubuntu 18.04 LTS
#################################################################################################

#################################################################################################
### !!! WARNING !!!
### THIS IS JUST A POC !!!
### ALL COMMANDS ARE ISSUED AS PRIVILEDGED USER !!!
### NOT TO BE USED IN PROD ENVS AS IS !!!
#################################################################################################

#################################################################################################
### preferred: static IP address, i.e. 192.168.74.138
### ssh server is not installed by default, it should be checked during installation process
#################################################################################################

#################################################################################################
### get the host up-to-date
#################################################################################################

sudo apt upgrade

#################################################################################################
### install pre-requisites (if not already present)
#################################################################################################

sudo apt install \
         apt-transport-https \
         ca-certificates \
         curl \
         software-properties-common

#################################################################################################
### add the GPG key for the official Docker repository to your system
#################################################################################################

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

#################################################################################################
### add Docker repository to APT sources
#################################################################################################

sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"

sudo apt update

#################################################################################################
### Make sure you are about to install from the Docker repo instead of the default Ubuntu repo
#################################################################################################

apt-cache policy docker-ce

#################################################################################################
### install docker
#################################################################################################

sudo apt install docker-ce

#################################################################################################
### Docker should now be installed, the daemon started, and the process enabled to start on boot.
### Now heck that itâ€™s running:
#################################################################################################

sudo systemctl status docker

#################################################################################################
### add your user to docker group, in order to be able to run docker w/o sudo
#################################################################################################

sudo usermod -aG docker ${USER}

#################################################################################################
### apply user group change
#################################################################################################

su - ${USER}

#################################################################################################
### make sure firewall is up
#################################################################################################

sudo ufw enable

#################################################################################################
### allow Rancher master required ports through firewall
### in prod, source ips should be limited to bare minimum
#################################################################################################

sudo ufw allow from any to any port 22 proto tcp
sudo ufw allow from any to any port 80 proto tcp
sudo ufw allow from any to any port 443 proto tcp
sudo ufw allow from any to any port 2376 proto tcp
sudo ufw allow from any to any port 6443 proto tcp
sudo ufw allow from any to any port 22 proto tcp

#################################################################################################
### check firewall status, make sure we're good to go
#################################################################################################

sudo ufw status numbered

# https://rancher.com/docs/rancher/v2.x/en/installation/references/

#################################################################################################
### now launch Rancher
#################################################################################################

docker run -d \
           --restart=unless-stopped \
           -p 80:80 -p 443:443 \
           rancher/rancher:latest

#################################################################################################
### now hit Rancher homepage, i.e.: https://my-rancher-master
#################################################################################################

#################################################################################################